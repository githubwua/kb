
# Enable Google OAuth Scopes on Cloud Composer

Ref: https://stackoverflow.com/questions/69817236/enable-google-drive-oauth-scopes-on-cloud-composer-2-0


1.  Create a [Google Cloud Airflow Connection](https://cloud.google.com/composer/docs/how-to/managing/connections#creating_a_connection_to_another_project)
    -   Name the Connection
    -   Specify a Service account key file path or JSON
    -   Specify the scopes you need to use to preform your task. (<https://www.googleapis.com/auth/spreadsheets>)
2.  Within your DAG, where you call on the operator to build the task, include the [parameter](https://airflow.apache.org/docs/apache-airflow-providers-google/stable/_api/airflow/providers/google/cloud/transfers/sheets_to_gcs/index.html#airflow.providers.google.cloud.transfers.sheets_to_gcs.GoogleSheetsToGCSOperator):
    -   **gcp\_conn\_id** \= '< name of connection >'

Cloud Composer v2 doesn't support OAuth on the Environment Level anymore because it now uses GKE Autopilot. 
GKE Autopilot does not support OAuth since this is a [legacy method](https://cloud.google.com/compute/docs/access/service-accounts#accesscopesiam) of GCE. 
For the connections that still need OAuth you will need to define these in an Airflow Connection and use the connection in your task. 
The scope of the connection seems to override and preexisting scopes that may be included by default, like the full `cloud-platform` scope. 
I had to specify both `spreadsheets` and `cloud-platform` in my connection for the [sheets\_to\_gcs](https://airflow.apache.org/docs/apache-airflow-providers-google/stable/_api/airflow/providers/google/cloud/transfers/sheets_to_gcs/index.html#airflow.providers.google.cloud.transfers.sheets_to_gcs.GoogleSheetsToGCSOperator) operator.


# Log Examples

## Task

### print statements from a task

```json
{
  "textPayload": "i=57; size=0.521366584GB",
  "insertId": "1t7p4c3f20t8rr",
  "resource": {
    "type": "cloud_composer_environment",
    "labels": {
      "environment_name": "my-composer",
      "location": "us-central1",
      "project_id": "my-project"
    }
  },
  "timestamp": "2024-08-16T01:08:46.644551700Z",
  "severity": "INFO",
  "labels": {
    "workflow": "create_list_with_many_strings",
    "task-id": "task0",
    "execution-date": "2024-08-16T01:07:31.141084+00:00",
    "try-number": "1",
    "map-index": "-1",
    "worker_id": "airflow-worker-f46qm",
    "process": "logging_mixin.py:188"
  },
  "logName": "projects/my-project/logs/airflow-worker",
  "receiveTimestamp": "2024-08-16T01:08:53.344803439Z"
}
```

Generated by this [code](https://cloud.google.com/composer/docs/composer-2/debug-out-of-memory-and-out-of-storage-dag-issues#out-of-memory).

textPayload contains the text generated by print()

The log entry indicates that a Cloud Composer environment named "my-composer" in the "us-central1" region is processing a task within a workflow called "create_list_with_many_strings". The task, identified as "task0", is being executed by a worker with the ID "airflow-worker-f46qm". The log entry also provides information about the task's execution date, try number, and map index. This is an informational log and does not indicate any potential issues.

## Execution of a task

The execution of a task is logged in two places:

- "logName": "projects/my-project/logs/stdout"
- "logName": "projects/my-project/logs/airflow-worker"

```json
{
  "textPayload": "[2024-08-16 01:07:36,358] {taskinstance.py:2307} INFO - Starting attempt 1 of 1@-@{\"workflow\": \"create_list_with_many_strings\", \"task-id\": \"task0\", \"execution-date\": \"2024-08-16T01:07:31.141084+00:00\", \"map-index\": \"-1\", \"try-number\": \"1\"}",
  "insertId": "1641ts3fdf2b13z8",
  "resource": {
    "type": "k8s_container",
    "labels": {
      "project_id": "my-project",
      "location": "us-central1",
      "container_name": "airflow-worker",
      "pod_name": "airflow-worker-f46qm",
      "cluster_name": "us-central1-my-composer-c62b10f9-gke",
      "namespace_name": "composer-2-9-0-airflow-2-9-1-c62b10f9"
    }
  },
  "timestamp": "2024-08-16T01:07:36.358399246Z",
  "severity": "INFO",
  "labels": {
    "k8s-pod/gcsfuse-consumer": "true",
    "k8s-pod/run": "airflow-worker",
    "compute.googleapis.com/resource_name": "gk3-us-central1-my-comp-nap-dhuz7b1h-2ce80376-mtcn"
  },
  "logName": "projects/my-project/logs/stdout",
  "receiveTimestamp": "2024-08-16T01:07:36.757836686Z"
}
```

```json
{
  "textPayload": "Starting attempt 1 of 1",
  "insertId": "11gs086f20n5yo",
  "resource": {
    "type": "cloud_composer_environment",
    "labels": {
      "location": "us-central1",
      "project_id": "my-project",
      "environment_name": "my-composer"
    }
  },
  "timestamp": "2024-08-16T01:07:36.358399246Z",
  "severity": "INFO",
  "labels": {
    "worker_id": "airflow-worker-f46qm",
    "task-id": "task0",
    "workflow": "create_list_with_many_strings",
    "process": "taskinstance.py:2307",
    "execution-date": "2024-08-16T01:07:31.141084+00:00",
    "try-number": "1",
    "map-index": "-1"
  },
  "logName": "projects/my-project/logs/airflow-worker",
  "receiveTimestamp": "2024-08-16T01:07:40.327036139Z"
}
```
